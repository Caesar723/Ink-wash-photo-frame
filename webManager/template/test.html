<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>国家 → 省/州 → 城市 · 配合你现有风格</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 你的 CSS（可直接粘贴你现有的） -->
  <style>
  :root {
    --bg: #f7f9fc;
    --card-bg: #fff;
    --accent: #007bff;
    --text: #333;
    --radius: 8px;
  }
  body { margin:0; background: var(--bg); color: var(--text); font-family: system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC"; }
  .page {
    min-height: 100vh;
    display: grid;
    place-items: center;
    padding: 24px;
  }
  .container {
    max-width: 760px; width: 100%;
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    padding: 20px;
  }
  h2 {
    font-size: 20px;
    margin-bottom: 12px;
  }

  /* —— Pill Toggle —— */
  .segmented {
    display: flex;
    background: #e9ecef;
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 16px;
  }
  .segmented input { display: none; }
  .segmented label {
    flex: 1;
    text-align: center;
    padding: 10px 0;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.3s, color 0.3s;
  }
  #hor:checked + label[for="hor"],
  #ver:checked + label[for="ver"] {
    background: var(--accent);
    color: #fff;
  }

  /* —— 表单格局 —— */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (max-width: 720px) { .form-grid { grid-template-columns: 1fr; } }
  .field { display: flex; flex-direction: column; gap: 6px; }
  .label { font-size: 13px; opacity: .8; }

  /* —— Select/Input —— */
  select, input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    border-radius: var(--radius);
    border: 1px solid #e5e7eb;
    background: #fff;
    color: var(--text);
    outline: none;
    font-size: 14px;
    transition: border-color .2s, box-shadow .2s;
  }
  select:focus, input[type="text"]:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,123,255,.15);
  }
  select:disabled, input:disabled { opacity: .6; cursor: not-allowed; }

  /* —— 按钮 —— */
  .btn-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
  .btn-submit {
    padding: 10px 14px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font-size: 14px;
    cursor: pointer;
    transition: background .2s;
  }
  .btn-submit:hover { background: #0056b3; }
  .btn-ghost {
    padding: 10px 14px;
    background: #eef2f7;
    color: #333;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius);
    font-size: 14px;
    cursor: pointer;
  }

  /* —— 结果卡 —— */
  .card {
    margin-top: 16px;
    border: 1px solid #eef2f7;
    border-radius: var(--radius);
    padding: 12px;
    background: #fff;
  }
  .kv { display: grid; grid-template-columns: 120px 1fr; gap: 8px 12px; }
  @media (max-width: 520px) { .kv { grid-template-columns: 1fr; } }
  .muted { color: #667085; }

  /* （你给的 Time‑picker / 组件拖拽样式此处保留，需要时可复用）
     .time-picker {...}, .spinner {...}, .component-list {...} 等 */
  </style>
</head>
<body>
  <main class="page">
    <section class="container">
      <h2>选择城市（国家 → 省/州 → 城市）</h2>

     

      <div id="picker" class="form-grid" data-dir="ver" aria-live="polite">
        <div class="field">
          <span class="label">国家 / 地区</span>
          <select id="country" aria-label="国家"></select>
          <small class="muted" id="country-hint">加载中…</small>
        </div>
        <div class="field">
          <span class="label">省 / 州</span>
          <select id="state" aria-label="省州" disabled></select>
          <small class="muted" id="state-hint">选择国家后加载</small>
        </div>
        <div class="field">
          <span class="label">城市</span>
          <select id="city" aria-label="城市" disabled></select>
          <small class="muted" id="city-hint">选择省/州后加载</small>
        </div>

      </div>

      <div class="btn-row">
        <button class="btn-submit" id="copy-coord" disabled>选择</button>
        
      </div>

      <div class="card" id="result" hidden>
        <div class="kv">
          <div class="muted">国家</div><div id="r-country">-</div>
          <div class="muted">省/州</div><div id="r-state">-</div>
          <div class="muted">城市</div><div id="r-city">-</div>
          <div class="muted">坐标</div><div id="r-coord">-</div>
          <div class="muted">OpenWeather</div><div id="r-q">-</div>
        </div>
      </div>
    </section>
  </main>

  <!-- 引入 country-state-city（ESM） -->
  <script type="module">
    import { Country, State, City } from 'https://cdn.jsdelivr.net/npm/country-state-city@3.2.1/+esm';

    // DOM
    const $country = document.getElementById('country');
    const $state   = document.getElementById('state');
    const $city    = document.getElementById('city');
    

    const $hintCountry = document.getElementById('country-hint');
    const $hintState   = document.getElementById('state-hint');
    const $hintCity    = document.getElementById('city-hint');

    const $status  = document.getElementById('status');
    const $result  = document.getElementById('result');
    const $rCountry= document.getElementById('r-country');
    const $rState  = document.getElementById('r-state');
    const $rCity   = document.getElementById('r-city');
    const $rCoord  = document.getElementById('r-coord');
    const $rQ      = document.getElementById('r-q');

    const $copyCoord = document.getElementById('copy-coord');
    const $copyQ     = document.getElementById('copy-q');
    const $picker = document.getElementById('picker');
    $picker.style.gridTemplateColumns = '1fr'

    // 工具：填充 select
    function fillSelect(sel, items, getValue, getText, placeholder, disableIfEmpty = true) {
      sel.innerHTML = '';
      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = placeholder;
      sel.appendChild(ph);

      items.forEach(it => {
        const opt = document.createElement('option');
        opt.value = getValue(it);
        opt.textContent = getText(it);
        sel.appendChild(opt);
      });

      sel.disabled = disableIfEmpty && items.length === 0;
      sel.value = '';
    }

    // 1) 国家
    const countries = Country.getAllCountries(); // [{name, isoCode, ...}]
    fillSelect($country, countries, c => c.isoCode, c => `${c.name}（${c.isoCode}）`, '请选择国家', false);
    $hintCountry.textContent = `共 ${countries.length} 个国家/地区`;

    // 2) 国家 → 省/州
    $country.addEventListener('change', () => {
      $result.hidden = true;
      $status.textContent = '已选择国家';
      const c = $country.value;

      // 重置
      fillSelect($state, [], s=>s, s=>s, '请选择省/州');
      fillSelect($city,  [], s=>s, s=>s, '请选择城市');
      
      $copyCoord.disabled = true; $copyQ.disabled = true;

      if (!c) { $hintState.textContent='选择国家后加载'; $hintCity.textContent='选择省/州后加载'; return; }

      const states = State.getStatesOfCountry(c); // [{name, isoCode, ...}]
      fillSelect($state, states, s => s.isoCode, s => s.name, states.length ? '请选择省/州' : '（该国无省/州数据）');
      $hintState.textContent = states.length ? `共 ${states.length} 个省/州` : '该国没有省/州数据';

      // 若无省/州，直接按国家加载城市
      if (states.length === 0) {
        const cities = City.getCitiesOfCountry(c);
        fillSelect($city, cities, x => x.name, x => x.name, cities.length ? '请选择城市' : '（无城市数据）');
        $hintCity.textContent = cities.length ? `该国共 ${cities.length} 个城市` : '未提供城市数据';
        
      } else {
        $hintCity.textContent = '选择省/州后加载';
      }
    });

    // 3) 省/州 → 城市（含搜索过滤）
    let currentCities = [];
    $state.addEventListener('change', () => {
      $result.hidden = true;
      $status.textContent = '已选择省/州';
      const c = $country.value, s = $state.value;

      if (!c) return;

      if (!s) {
        currentCities = City.getCitiesOfCountry(c);
      } else {
        currentCities = City.getCitiesOfState(c, s);
      }
      fillSelect($city, currentCities, x => x.name, x => x.name, currentCities.length ? '请选择城市' : '（无城市数据）');
      $hintCity.textContent = currentCities.length ? `共 ${currentCities.length} 个城市` : '未提供城市数据';

    });

    

    // 4) 城市 → 结果
    $city.addEventListener('change', () => {
      const c = $country.value, s = $state.value, cityName = $city.value;
      if (!c || !cityName) { $result.hidden = true; $copyCoord.disabled = true; $copyQ.disabled = true; return; }

      const country = countries.find(x => x.isoCode === c);
      const state   = s ? State.getStatesOfCountry(c).find(x => x.isoCode === s) : null;

      // 在两种来源里找城市（按省或按国）
      let city = null;
      if (s) city = City.getCitiesOfState(c, s).find(x => x.name === cityName);
      if (!city) city = City.getCitiesOfCountry(c).find(x => x.name === cityName);

      const coord = city && city.latitude && city.longitude ? `${city.latitude}, ${city.longitude}` : '无';
      const q = `${cityName},${c.toLowerCase()}`;

      $rCountry.textContent = `${country ? country.name : c}（${c}）`;
      $rState.textContent   = state ? state.name : '—';
      $rCity.textContent    = cityName;
      $rCoord.textContent   = coord;
      $rQ.textContent       = q;

      $copyCoord.disabled = coord === '无';
      $copyQ.disabled     = false;
      $result.hidden = false;
      $status.textContent = '选择完成';
    });

    // 复制工具（有 Clipboard API 则用，没有就降级）
    
  </script>
</body>
</html>
